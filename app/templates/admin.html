{% extends "base.html" %}
{% block content %}
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
</head>
<nav class="navbar navbar-expand-lg navbar-light">
  <a class="navbar-brand" href="/">VeriFace</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item active">
        <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/logout">Logout</a>
      </li>
    </ul>
  </div>
</nav>
<br>

<p>{{moment().format('LLL')}}</p>

<div class="container">
  <h2>Users</h2>
  <table>
    <thead>
      <tr>
        <th>Username</th>
        <th>Requested Role</th>
        <th>Picture Approval Status</th>
        <th>User Role Approval Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>{{ user.username }}</td>
        <td>{{ user.reg_role }}</td>
        {% if user.picApprove == 1 %}
        <td><a href="{{ url_for('ApprovePicture', id=user.id) }}">Yes Pic</a></td>
        {% else %}
        <td><a href="{{ url_for('UnPicture', id=user.id) }}">Bad Pic</a></td>
        {% endif %}
        {% if user.roleApprove == 1 %}
        <td><a href="{{ url_for('ApproveUser', id=user.id) }}">Approve Role</a></td>
        {% else %}
        <td><a href="{{ url_for('UnapproveUser', id=user.id) }}">Change Role</a></td>
        {% endif %}
        <td>
          <button onclick="openRfidPopup('{{ user.id }}')">Scan RFID</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
  <script>
      function openRfidPopup(userId) {
          const popup = window.open(
              "/rfid_scan_popup",
              "RFID Scanner",
              "width=400,height=300"
          );
  
          window.addEventListener("message", function (event) {
              if (event.data && event.data.rfid_tag) {
                  const rfidTag = event.data.rfid_tag;
                  console.log("RFID Tag received:", rfidTag);
  
                  // Send the RFID tag to the server to assign it to the user
                  fetch(`/assign_rfid_to_user/${userId}`, {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ rfid_tag: rfidTag }),
                  })
                      .then((response) => response.json())
                      .then((data) => {
                          if (data.success) {
                              alert("RFID tag assigned successfully!");
                              location.reload(); // Reload the page to reflect changes
                          } else {
                              alert(data.message || "Error assigning RFID tag.");
                          }
                      })
                      .catch((error) => {
                          console.error("Error:", error);
                          alert("Error assigning RFID tag.");
                      });
              }
          });
      }
  </script>
  
</div>
{% endblock %}
